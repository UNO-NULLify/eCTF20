<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Encryption | eCTF Documentation</title>
    <meta name="description" content="NULLify">
    
    
    <link rel="preload" href="/assets/css/0.styles.78f28ec0.css" as="style"><link rel="preload" href="/assets/js/app.1a38b3e9.js" as="script"><link rel="preload" href="/assets/js/2.d81d59a6.js" as="script"><link rel="preload" href="/assets/js/19.8a7d5380.js" as="script"><link rel="prefetch" href="/assets/js/10.007dda0f.js"><link rel="prefetch" href="/assets/js/11.13cf8a39.js"><link rel="prefetch" href="/assets/js/12.914841a3.js"><link rel="prefetch" href="/assets/js/13.fa5546fe.js"><link rel="prefetch" href="/assets/js/14.aa7165da.js"><link rel="prefetch" href="/assets/js/15.e18563b9.js"><link rel="prefetch" href="/assets/js/16.000a4300.js"><link rel="prefetch" href="/assets/js/17.de36a721.js"><link rel="prefetch" href="/assets/js/18.2dc52e2d.js"><link rel="prefetch" href="/assets/js/20.f3895d39.js"><link rel="prefetch" href="/assets/js/21.48e417ca.js"><link rel="prefetch" href="/assets/js/22.949c40a6.js"><link rel="prefetch" href="/assets/js/23.7e7c4a24.js"><link rel="prefetch" href="/assets/js/24.2d48901e.js"><link rel="prefetch" href="/assets/js/25.ceaddddd.js"><link rel="prefetch" href="/assets/js/3.d4afdc96.js"><link rel="prefetch" href="/assets/js/4.90489dad.js"><link rel="prefetch" href="/assets/js/5.037880d8.js"><link rel="prefetch" href="/assets/js/6.071b6179.js"><link rel="prefetch" href="/assets/js/7.f0459ecd.js"><link rel="prefetch" href="/assets/js/8.f6099ec2.js"><link rel="prefetch" href="/assets/js/9.48e6ce21.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78f28ec0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/nullify_lock_no_padding.png" alt="eCTF Documentation" class="logo"> <span class="site-name can-hide">eCTF Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link router-link-active">Technical Reference</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link router-link-active">Technical Reference</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/mitre/" class="sidebar-heading clickable"><span>Official Documentation</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/technical-reference/" class="sidebar-heading clickable router-link-active open"><span>Technical Reference</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/technical-reference/authentication.html" class="sidebar-link">Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/authentication.html#login" class="sidebar-link">Login</a></li><li class="sidebar-sub-header"><a href="/technical-reference/authentication.html#logout" class="sidebar-link">Logout</a></li></ul></li><li><a href="/technical-reference/querying.html" class="sidebar-link">Querying</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/querying.html#query-song" class="sidebar-link">Query Song</a></li><li class="sidebar-sub-header"><a href="/technical-reference/querying.html#query-player" class="sidebar-link">Query Player</a></li></ul></li><li><a href="/technical-reference/encryption.html" class="active sidebar-link">Encryption</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#protect-song" class="sidebar-link">Protect Song</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#encrypt-song" class="sidebar-link">Encrypt Song</a></li></ul></li><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#generating-secrets" class="sidebar-link">Generating Secrets</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#generating-full-secret" class="sidebar-link">Generating Full Secret</a></li><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#generating-30-second-secret" class="sidebar-link">Generating 30 Second Secret</a></li></ul></li></ul></li><li><a href="/technical-reference/sharing.html" class="sidebar-link">Sharing</a></li><li><a href="/technical-reference/playing.html" class="sidebar-link">Playing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#playing-full-song" class="sidebar-link">Playing Full Song</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#decrypting-a-full-song" class="sidebar-link">Decrypting a full song</a></li></ul></li><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#playing-a-shared-song" class="sidebar-link">Playing a Shared Song</a></li><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#playing-30-second-sample" class="sidebar-link">Playing 30 Second Sample</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#decrypting-30-second-sample" class="sidebar-link">Decrypting 30 second sample</a></li></ul></li></ul></li><li><a href="/technical-reference/metadata.html" class="sidebar-link">Song Metadata</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="encryption"><a href="#encryption" class="header-anchor">#</a> Encryption</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>For symmetric encryption, we are using two different algorithms: XSalsa20-Poly1305 and XChaCha20-Poly1305. XSalsa20 is used in the “secret box” functions, functions pre-packed so they are easy to use and hard to mess-up, for the various string encryption cases. XSalsa20 has no known attacks against it and it is unlikely that our adversaries will develop their own. For the actual file encryption, we are using XChaCha20-Poly1305. ChaCha20 is a modification of Salsa20 that increases the diffusion per round and achieves the same or better performance. Furthermore, libsodium has well-documented examples on how to properly implement file or stream encryption with ChaCha20, thus to keep from messing up the crypto algorithms we are staying as close to their official design speck as possible. ChaCha20 like Salsa20 is secure to date from cryptanalysis at a key size larger than or equal to 128.</p> <p>For asymmetric encryption, we are using Curve25519 high-speed elliptic curve cryptography. This, like Salsa20, has a well made public-private box system that is very hard to mess up that we are using to write our encryption functions. Only small strings will be encrypted with ECC. This particular curve is used in hundreds of libraries including OpenSSL, GnuTLS, and SSH. We were not able to locate any attacks that other teams may use against this algorithm if properly implemented.</p> <p>For digital signatures, we are using the Ed25519 digital signature system. This function is also nicely packaged with libsodium so that we can sign and authenticate our songs. This is based on the EC 25519, so the same security applies.</p> <p>For password hashing, we are using argon2id. This works by having multiple rounds of hashing to increase the time required to brute-force a pin. The chance of collision is incredibly low, so the security of the encrypted pins depends entirely on their lengths. No matter what we do, short pins will always be able to be brute-forced. We are using a libsodium library to implement this correctly.</p> <p>For regular hashing, we are using Blake2b. Blake2b is a very fast and secure hashing function that we are using to ensure that encryption keys are generated on the fly. Blake2b is used by Argon2, the winner of the password hashing competition. We are using a libsodium library to ensure that this algorithm is correctly implemented.</p> <p>Things being secured by crypto:</p> <ul><li>Login 8-64 digit pin (up to 64 users)</li> <li>Sharing the Songs (If owner of song)</li> <li>Region Locking (a MiPod can have up to 32 regions)</li> <li>No song modification</li> <li>No custom music</li> <li>No listening to full songs you don't have perms to</li> <li>No listening to song preview on non MiPod device</li></ul> <h2 id="protect-song"><a href="#protect-song" class="header-anchor">#</a> Protect Song</h2> <p>Since protect song is run during provisioning, we decided to write this in Python. We start by creating a <code>songKey</code>, which is the hashed combination of the users pin hash, pin, and the songName. This will be used later.</p> <div class="language-python extra-class"><pre class="language-text"><code>songKey = monocypher.blake2b(bytes(users[&quot;users&quot;][args.owner][&quot;pin_hash&quot;], encoding=&quot;utf-8&quot;) + \
                                bytes(users[&quot;users&quot;][args.owner][&quot;pin&quot;], encoding=&quot;utf-8&quot;) + songName)
</code></pre></div><p>Next, we use the random password for each region as the key for monocypher's locking function.</p> <div class="language-python extra-class"><pre class="language-text"><code>for r in args.region_list:
    rand_pass = regions[r][&quot;rand_pass&quot;]
    encrypted = monocypher.lock(bytes.fromhex(rand_pass), nonce, regionKey)
</code></pre></div><p>We can then store this encrypted text in the regionSecrets in the song metadata to be used for decryption.</p> <p>Next, we create a hardware secret hash for both the full song, and the 30 second sample. This hardware secret is the hashed combination of the owners hardware secrets, and the song name. The 30 second hash has an additional &quot;30&quot; appended for differentiation.</p> <div class="language-python extra-class"><pre class="language-text"><code>hardwareSecretHash = monocypher.blake2b(bytes(users[&quot;users&quot;][args.owner][&quot;hw_secret&quot;],
                     encoding=&quot;utf-8&quot;) + songName).hex()
hardwareSecretHash30 = monocypher.blake2b(bytes(users[&quot;users&quot;][args.owner][&quot;hw_secret&quot;],
                     encoding=&quot;utf-8&quot;) + songName + bytes(&quot;30&quot;,
                     encoding=&quot;utf-8&quot;)).hex()
</code></pre></div><p>All of this information is then passed to the <code>encryptSong</code> c file as follows:</p> <div class="language-python extra-class"><pre class="language-text"><code>call([&quot;./encryptSong&quot;,
    str(users[&quot;users&quot;][args.owner][&quot;id&quot;]),
    &quot;,&quot;.join([str(x) for x in region_ids_tmp]),
    &quot;,&quot;.join([str(x) for x in regionSecretList]),
    args.infile.split(&quot;/&quot;)[-1],
    smallFile,
    str(hardwareSecretHash30),
    args.infile,
    str(songKey.hex())+str(regionKey.hex())+str(hardwareSecretHash),
    args.outfile,
    str(users[&quot;root_sign&quot;]),
    str(users[&quot;root_verify&quot;])
])
</code></pre></div><h3 id="encrypt-song"><a href="#encrypt-song" class="header-anchor">#</a> Encrypt Song</h3> <p>Since <code>encryptSong</code> is called internally, there are a number of arguments needed for the program to run:</p> <ul><li><code>argv[1]</code>: owner_id</li> <li><code>argv[2]</code>: region_ids</li> <li><code>argv[3]</code>: region_secrets</li> <li><code>argv[4]</code>: song_name</li> <li><code>argv[5]</code>: 30path</li> <li><code>argv[6]</code>: 30secret</li> <li><code>argv[7]</code>: fullpath</li> <li><code>argv[8]</code>: secret</li> <li><code>argv[9]</code>: outFile</li> <li><code>argv[10]</code>: root_sign</li> <li><code>argv[11]</code>: pub_key</li></ul> <p>The first thing this function does is takes the data it was given and populated the metadata structure. Owner ID, Region IDs, Region Secrets, and song name are all initialized and written to the metadata structure here.</p> <p>Next, we create a hash of the secret with BLAKE2b as follows:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_blake2b(hash, secret, 160);
</code></pre></div><p>This hash is then passed to monocyphers lock function:</p> <div class="language-c extra-class"><pre class="language-text"><code>encrypt(encFile, argv[7], hash, nonce) != 0)
</code></pre></div><p>The same process is then done with the 30 second secret.</p> <p>Finally, we make a signature of the song to ensure there is no tampering done in the future. This is done using monocyphers <a href="https://monocypher.org/manual/sign" target="_blank" rel="noopener noreferrer">crypto_sign<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> function. <code>crypto_sign()</code> provides EdDSA public key signatures and verification.</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_sign(signature, root_verify, public_key, toSign, sizeof toSign);
</code></pre></div><h2 id="generating-secrets"><a href="#generating-secrets" class="header-anchor">#</a> Generating Secrets</h2> <h3 id="generating-full-secret"><a href="#generating-full-secret" class="header-anchor">#</a> Generating Full Secret</h3> <p>The <code>generateSecret</code> function takes 2 arguments:</p> <ul><li><code>struct metadata *meta</code> - A pointer to the song <a href="/technical-reference/metadata.html">metadata structure</a>.</li> <li><code>char *pin</code> - The current users pin.</li></ul> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t * generateSecret(char *pin, struct metadata *meta) {}
</code></pre></div><p>The first step in generating the secret is to generate the regionKey used during provisioning. We can get the information needed for this by taking the first 64 bytes of <code>region_secrets</code> in the metadata, which is the message, then getting the next 32 bytes, which is the MAC.</p> <div class="language-c extra-class"><pre class="language-text"><code>// ------------ Generate regionKey ------------
uint8_t mac[32+1] = {0};
uint8_t msg[64+1] = {0};

// First 64 of region_secret is the encrypted msg. Second 32 is the mac.
for(int i = 0; i &lt; 96; i++) {
    if(i &lt; 64) {
        msg[i] = meta-&gt;region_secrets[0][i];
    } else {
        mac[(i-64)] = meta-&gt;region_secrets[0][i];
    }
}
</code></pre></div><p>After doing some hex conversions, we can pass this information to monocypher's <code>crypto_unlock</code> function to unlock the <code>regionKey</code>.</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_unlock(regionKey, bytesPass, nonce, bytesMac, bytesMsg, sizeof(bytesMsg));
</code></pre></div><p>Now that we have the <code>regionKey</code> generated, we need to generate the hardwareSecretHash. This can be done by combining the <code>hw_secret</code> and song name from the metadata, then hasing it with monocyphers BLAKE2b:</p> <div class="language-c extra-class"><pre class="language-text"><code>// ------------ Generate hardwareSecretHash ------------
uint8_t *hshu = malloc(strlen(user_data[i].hw_secret) + strlen(meta-&gt;song_name));
memcpy(hshu, user_data[i].hw_secret, strlen(user_data[i].hw_secret));
memcpy(hshu + strlen(user_data[i].hw_secret), meta-&gt;song_name, strlen(meta-&gt;song_name));

uint8_t hardwareSecretHash[64] = {0};
crypto_blake2b(hardwareSecretHash, hshu, strlen((char *)hshu));
</code></pre></div><p>Next, we need to generate the <code>songKey</code>. This is a combination of the <code>pin_hash</code> from the <code>device_secrets</code>, the users pin, and the name of the song. Hash this with BLAKE2b, and you have the <code>songKey</code>:</p> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t *song_str = malloc(strlen(user_data[i].pin_hash) + strlen(pin) + strlen(meta-&gt;song_name));
memcpy(song_str, user_data[i].pin_hash, strlen(user_data[i].pin_hash));
memcpy(song_str + strlen(user_data[i].pin_hash), pin, strlen(pin));
memcpy(song_str + strlen(user_data[i].pin_hash) + strlen(pin), meta-&gt;song_name, strlen(meta-&gt;song_name));

uint8_t songKey[64] = {0};
crypto_blake2b(songKey, song_str, strlen((char *)song_str));
</code></pre></div><p>Finally, we can combine the regionKey, songKey, and hardwareSecretHash that we generated to get the full secret:</p> <div class="language-c extra-class"><pre class="language-text"><code>// ------------ Generate Secret ------------
uint8_t secret[sizeof(songKey) + sizeof(regionKey) + sizeof(hardwareSecretHash)] = {0};

memcpy(secret, songKey, sizeof(songKey));
memcpy(secret+sizeof(songKey), regionKey, sizeof(regionKey));
memcpy(secret+sizeof(songKey)+sizeof(regionKey), hardwareSecretHash, sizeof(hardwareSecretHash));
</code></pre></div><h3 id="generating-30-second-secret"><a href="#generating-30-second-secret" class="header-anchor">#</a> Generating 30 Second Secret</h3> <p>The <code>generate30Secret</code> function only takes 1 argument, as no pin is needed for a sample:</p> <ul><li><code>struct metadata *meta</code> - A pointer to the song <a href="/technical-reference/metadata.html">metadata structure</a>.</li></ul> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t * generate30Secret(struct metadata *meta) {}
</code></pre></div><p>The 30 second secret is a combination of the hardwareSecretHash30 stored in the <code>device_secrets</code>, the hardware secret, the song name, and &quot;30&quot;, just like in the provisioning process.</p> <div class="language-c extra-class"><pre class="language-text"><code>// ------------ Generate hardwareSecretHash30 ------------
uint8_t *hsh30 = malloc(strlen(user_data[i].hw_secret) + strlen(meta-&gt;song_name) + 2); // +2 for the 30
memcpy(hsh30, user_data[i].hw_secret, strlen(user_data[i].hw_secret));
memcpy(hsh30 + strlen(user_data[i].hw_secret), meta-&gt;song_name, strlen(meta-&gt;song_name));
memcpy(hsh30 + strlen(user_data[i].hw_secret) + strlen(meta-&gt;song_name), &quot;30&quot;, 2);
</code></pre></div><p>Finally, we hash that string with monocyphers BLAKE2b function, and return it to the parent function:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_blake2b(hardwareSecretHash30, hsh30, strlen((char *)hsh30));
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/24/2020, 9:26:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technical-reference/querying.html" class="prev">Querying</a></span> <span class="next"><a href="/technical-reference/sharing.html">Sharing</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a38b3e9.js" defer></script><script src="/assets/js/2.d81d59a6.js" defer></script><script src="/assets/js/19.8a7d5380.js" defer></script>
  </body>
</html>
