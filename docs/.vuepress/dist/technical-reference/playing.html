<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Playing | eCTF Documentation</title>
    <meta name="description" content="NULLify">
    
    
    <link rel="preload" href="/assets/css/0.styles.78f28ec0.css" as="style"><link rel="preload" href="/assets/js/app.1a38b3e9.js" as="script"><link rel="preload" href="/assets/js/2.d81d59a6.js" as="script"><link rel="preload" href="/assets/js/21.48e417ca.js" as="script"><link rel="prefetch" href="/assets/js/10.007dda0f.js"><link rel="prefetch" href="/assets/js/11.13cf8a39.js"><link rel="prefetch" href="/assets/js/12.914841a3.js"><link rel="prefetch" href="/assets/js/13.fa5546fe.js"><link rel="prefetch" href="/assets/js/14.aa7165da.js"><link rel="prefetch" href="/assets/js/15.e18563b9.js"><link rel="prefetch" href="/assets/js/16.000a4300.js"><link rel="prefetch" href="/assets/js/17.de36a721.js"><link rel="prefetch" href="/assets/js/18.2dc52e2d.js"><link rel="prefetch" href="/assets/js/19.8a7d5380.js"><link rel="prefetch" href="/assets/js/20.f3895d39.js"><link rel="prefetch" href="/assets/js/22.949c40a6.js"><link rel="prefetch" href="/assets/js/23.7e7c4a24.js"><link rel="prefetch" href="/assets/js/24.2d48901e.js"><link rel="prefetch" href="/assets/js/25.ceaddddd.js"><link rel="prefetch" href="/assets/js/3.d4afdc96.js"><link rel="prefetch" href="/assets/js/4.90489dad.js"><link rel="prefetch" href="/assets/js/5.037880d8.js"><link rel="prefetch" href="/assets/js/6.071b6179.js"><link rel="prefetch" href="/assets/js/7.f0459ecd.js"><link rel="prefetch" href="/assets/js/8.f6099ec2.js"><link rel="prefetch" href="/assets/js/9.48e6ce21.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78f28ec0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/nullify_lock_no_padding.png" alt="eCTF Documentation" class="logo"> <span class="site-name can-hide">eCTF Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link router-link-active">Technical Reference</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link router-link-active">Technical Reference</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/mitre/" class="sidebar-heading clickable"><span>Official Documentation</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/technical-reference/" class="sidebar-heading clickable router-link-active open"><span>Technical Reference</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/technical-reference/authentication.html" class="sidebar-link">Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/authentication.html#login" class="sidebar-link">Login</a></li><li class="sidebar-sub-header"><a href="/technical-reference/authentication.html#logout" class="sidebar-link">Logout</a></li></ul></li><li><a href="/technical-reference/querying.html" class="sidebar-link">Querying</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/querying.html#query-song" class="sidebar-link">Query Song</a></li><li class="sidebar-sub-header"><a href="/technical-reference/querying.html#query-player" class="sidebar-link">Query Player</a></li></ul></li><li><a href="/technical-reference/encryption.html" class="sidebar-link">Encryption</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#protect-song" class="sidebar-link">Protect Song</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#encrypt-song" class="sidebar-link">Encrypt Song</a></li></ul></li><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#generating-secrets" class="sidebar-link">Generating Secrets</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#generating-full-secret" class="sidebar-link">Generating Full Secret</a></li><li class="sidebar-sub-header"><a href="/technical-reference/encryption.html#generating-30-second-secret" class="sidebar-link">Generating 30 Second Secret</a></li></ul></li></ul></li><li><a href="/technical-reference/sharing.html" class="sidebar-link">Sharing</a></li><li><a href="/technical-reference/playing.html" class="active sidebar-link">Playing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#playing-full-song" class="sidebar-link">Playing Full Song</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#decrypting-a-full-song" class="sidebar-link">Decrypting a full song</a></li></ul></li><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#playing-a-shared-song" class="sidebar-link">Playing a Shared Song</a></li><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#playing-30-second-sample" class="sidebar-link">Playing 30 Second Sample</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/technical-reference/playing.html#decrypting-30-second-sample" class="sidebar-link">Decrypting 30 second sample</a></li></ul></li></ul></li><li><a href="/technical-reference/metadata.html" class="sidebar-link">Song Metadata</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="playing"><a href="#playing" class="header-anchor">#</a> Playing</h1> <p>When playing a song, the first step is to determine if the song is owned by the current user, shared with the current user, or neither. This determines if the full song, shared song, or 30 second sample are played back to the user. The process is as follows:</p> <p><img src="/playSong.png" alt="Play Song Flowchart"></p> <h2 id="playing-full-song"><a href="#playing-full-song" class="header-anchor">#</a> Playing Full Song</h2> <p>To play the full song, there are three arguments that are needed:</p> <ul><li><code>FILE *encFile</code> - A pointer to the song file.</li> <li><code>struct metadata *meta</code> - A pointer to the song <a href="/technical-reference/metadata.html">metadata structure</a>.</li> <li><code>char *pin</code> - The current users pin. This is used to generate the secret for decryption.</li></ul> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t playFull(FILE *encFile, struct metadata *meta, char *pin) {

  // Generate full secret
  uint8_t *secret = generateSecret(pin, meta);

  // Decrypt full song
  return decryptFull(encFile, meta, secret);
}
</code></pre></div><p>First, we need to generate the secret key used to decrypt the song. For a detailed explanation on this process, refer to the <a href="/technical-reference/encryption.html#generating-secrets">Secret Generation documentation</a>.</p> <p>A pointer to this secret is then passed to the <code>decryptFull</code> function, along with the file pointer and metadata pointer, which will decrypt the song.</p> <p>The function returns a uint8_t, either 0 or 1, to indicate success or failure. This pass/fail code comes from the return of <code>decryptFull</code>.</p> <h3 id="decrypting-a-full-song"><a href="#decrypting-a-full-song" class="header-anchor">#</a> Decrypting a full song</h3> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t decryptFull(FILE *encFile, struct metadata *meta, uint8_t *secret) {}
</code></pre></div><p>The first step to decrypting a song is to hash the secret with BLAKE2b:</p> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t hash[64] = {0};
crypto_blake2b(hash, secret, 160);
</code></pre></div><p>We can then use this hash as the key for <a href="https://monocypher.org/" target="_blank" rel="noopener noreferrer">monocypher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>'s <code>crypto_unlock</code> function to do the decryption:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_unlock(buf_out, key, nonce, mac, buf_in, rlen)
</code></pre></div><h2 id="playing-a-shared-song"><a href="#playing-a-shared-song" class="header-anchor">#</a> Playing a Shared Song</h2> <p>The <code>playShared</code> song takes 4 arguments:</p> <ul><li><code>FILE *encFile</code> - A pointer to the song file.</li> <li><code>struct metadata *meta</code> - A pointer to the song <a href="/technical-reference/metadata.html">metadata structure</a>.</li> <li><code>uint8_t uid</code> - The ID of the current user.</li> <li><code>char *pin</code> - The current users pin. This is used to generate the secret for decryption.</li></ul> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t playShared(FILE *encFile, struct metadata *meta, uint8_t uid, char *pin){}
</code></pre></div><p>The first step to playing a shared song is to generate a hash of the users pin with BLAKE2b:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_blake2b(pin_hash, pin, sizeof(pin));
</code></pre></div><p>We can then get the encrypted private key from the <code>device_secrets</code> file, and use the hashed pin to decrypt the private key:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_unlock(pvt_key, pin_hash, nonce, mac, enc_pvt_key, 32);
</code></pre></div><p>This private key allows us to use <a href="https://monocypher.org/" target="_blank" rel="noopener noreferrer">monocypher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>'s <code>crypto_key_exchange</code> function to compute a shared key with the shared users secret key and the owners public key:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_key_exchange(shared_key, pvt_key, pub_key);
</code></pre></div><p>Next, we need to decrypt the sharedInfo section of the metadata at that user ID's index.</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_unlock(decrypted, shared_key, nonceDec, meta-&gt;sharedInfo[uid-1] + 32, meta-&gt;sharedInfo[uid-1], 32);
</code></pre></div><p>Finally, we can use this information in <a href="https://monocypher.org/" target="_blank" rel="noopener noreferrer">monocypher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>'s <code>crypto_unlock</code> function to finish off decrypting the song:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_unlock(buf_out, key, nonce, mac, buf_in, rlen)
</code></pre></div><h2 id="playing-30-second-sample"><a href="#playing-30-second-sample" class="header-anchor">#</a> Playing 30 Second Sample</h2> <p>Only two arguments are needed to play the 30 second sample of a song, as no pin is needed for decryption. There arguments needed are:</p> <ul><li><code>FILE *encFile</code> - A pointer to the song file.</li> <li><code>struct metadata *meta</code> - A pointer to the song <a href="/technical-reference/metadata.html">metadata structure</a>.</li></ul> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t play30(FILE *encFile, struct metadata *meta) {
  // Generate 30 secret
  uint8_t *secret30 = generate30Secret(meta);

  // Decrypt 30 second sample
  return decrypt30(encFile, meta, secret30);
}
</code></pre></div><p>First, we need to generate the secret key used to decrypt the sample. Generating secrets is explained in greater detail in the <a href="/technical-reference/encryption.html#generating-secrets">Secret Generation documentation</a>.</p> <p>A pointer to the 30 second secret is then passed to the <code>decrypt30</code> function, along with the file pointer and metadata pointer, which will decrypt the 30 second sample.</p> <p>The function returns the value of the <code>decrypt30</code> call, which is a 0 for success, and 1 for failure.</p> <h3 id="decrypting-30-second-sample"><a href="#decrypting-30-second-sample" class="header-anchor">#</a> Decrypting 30 second sample</h3> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t decrypt30(FILE *encFile, struct metadata *meta, uint8_t *secret30) {}
</code></pre></div><p>The first step to decrypting the 30 second sample is to hash the 30 second secret with BLAKE2b:</p> <div class="language-c extra-class"><pre class="language-text"><code>uint8_t hash[64] = {0};
crypto_blake2b(hash, (const uint8_t *) secret30, strlen(secret30));
</code></pre></div><p>We can then use this hash as the key for <a href="https://monocypher.org/" target="_blank" rel="noopener noreferrer">monocypher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>'s <code>crypto_unlock</code> function to do the decryption:</p> <div class="language-c extra-class"><pre class="language-text"><code>crypto_unlock(buf_out, key, nonce, mac, buf_in, rlen)
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/24/2020, 9:26:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/technical-reference/sharing.html" class="prev">Sharing</a></span> <span class="next"><a href="/technical-reference/metadata.html">Song Metadata</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a38b3e9.js" defer></script><script src="/assets/js/2.d81d59a6.js" defer></script><script src="/assets/js/21.48e417ca.js" defer></script>
  </body>
</html>
