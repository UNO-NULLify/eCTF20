<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hardware Considerations | eCTF Documentation</title>
    <meta name="description" content="NULLify">
    
    
    <link rel="preload" href="/assets/css/0.styles.78f28ec0.css" as="style"><link rel="preload" href="/assets/js/app.1a38b3e9.js" as="script"><link rel="preload" href="/assets/js/2.d81d59a6.js" as="script"><link rel="preload" href="/assets/js/14.aa7165da.js" as="script"><link rel="prefetch" href="/assets/js/10.007dda0f.js"><link rel="prefetch" href="/assets/js/11.13cf8a39.js"><link rel="prefetch" href="/assets/js/12.914841a3.js"><link rel="prefetch" href="/assets/js/13.fa5546fe.js"><link rel="prefetch" href="/assets/js/15.e18563b9.js"><link rel="prefetch" href="/assets/js/16.000a4300.js"><link rel="prefetch" href="/assets/js/17.de36a721.js"><link rel="prefetch" href="/assets/js/18.2dc52e2d.js"><link rel="prefetch" href="/assets/js/19.8a7d5380.js"><link rel="prefetch" href="/assets/js/20.f3895d39.js"><link rel="prefetch" href="/assets/js/21.48e417ca.js"><link rel="prefetch" href="/assets/js/22.949c40a6.js"><link rel="prefetch" href="/assets/js/23.7e7c4a24.js"><link rel="prefetch" href="/assets/js/24.2d48901e.js"><link rel="prefetch" href="/assets/js/25.ceaddddd.js"><link rel="prefetch" href="/assets/js/3.d4afdc96.js"><link rel="prefetch" href="/assets/js/4.90489dad.js"><link rel="prefetch" href="/assets/js/5.037880d8.js"><link rel="prefetch" href="/assets/js/6.071b6179.js"><link rel="prefetch" href="/assets/js/7.f0459ecd.js"><link rel="prefetch" href="/assets/js/8.f6099ec2.js"><link rel="prefetch" href="/assets/js/9.48e6ce21.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78f28ec0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/nullify_lock_no_padding.png" alt="eCTF Documentation" class="logo"> <span class="site-name can-hide">eCTF Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link router-link-active">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link">Technical Reference</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link router-link-active">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link">Technical Reference</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/mitre/" class="sidebar-heading clickable router-link-active open"><span>Official Documentation</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mitre/overview.html" class="sidebar-link">System Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/overview.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#usage" class="sidebar-link">Usage</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#mipod-command-information" class="sidebar-link">miPod Command Information</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#media-command-information" class="sidebar-link">Media Command Information</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#operating-times" class="sidebar-link">Operating Times</a></li></ul></li><li><a href="/mitre/implementation.html" class="sidebar-link">Security Implementation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/implementation.html#protection-of-flags" class="sidebar-link">Protection of Flags</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/implementation.html#region-lock" class="sidebar-link">Region Lock</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#unauthorized-play" class="sidebar-link">Unauthorized Play</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#pin-extraction" class="sidebar-link">Pin Extraction</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#music-tamper" class="sidebar-link">Music Tamper</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#custom-music" class="sidebar-link">Custom Music</a></li></ul></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#compiler-changes" class="sidebar-link">Compiler Changes</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#hardware-changes" class="sidebar-link">Hardware Changes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/implementation.html#hardware-integrity-module" class="sidebar-link">Hardware Integrity Module</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#command-register" class="sidebar-link">Command Register</a></li></ul></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#data-flow" class="sidebar-link">Data Flow</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#watchdog" class="sidebar-link">Watchdog</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#integrity-monitor" class="sidebar-link">Integrity Monitor</a></li></ul></li><li><a href="/mitre/attack.html" class="sidebar-link">Attack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/attack.html#potential-vulnerabilities" class="sidebar-link">Potential Vulnerabilities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/attack.html#mipod" class="sidebar-link">miPod</a></li><li class="sidebar-sub-header"><a href="/mitre/attack.html#drm" class="sidebar-link">DRM</a></li><li class="sidebar-sub-header"><a href="/mitre/attack.html#security-and-function-overview" class="sidebar-link">Security and function Overview</a></li><li class="sidebar-sub-header"><a href="/mitre/attack.html#hardware" class="sidebar-link">Hardware</a></li></ul></li></ul></li><li><a href="/mitre/hardware.html" class="active sidebar-link">Hardware Considerations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/hardware.html#security-challenges" class="sidebar-link">Security Challenges</a></li><li class="sidebar-sub-header"><a href="/mitre/hardware.html#microblaze-performance" class="sidebar-link">Microblaze Performance</a></li><li class="sidebar-sub-header"><a href="/mitre/hardware.html#song-datapath" class="sidebar-link">Song Datapath</a></li><li class="sidebar-sub-header"><a href="/mitre/hardware.html#memory" class="sidebar-link">Memory</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/technical-reference/" class="sidebar-heading clickable"><span>Technical Reference</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="hardware-considerations"><a href="#hardware-considerations" class="header-anchor">#</a> Hardware Considerations</h1> <h2 id="security-challenges"><a href="#security-challenges" class="header-anchor">#</a> Security Challenges</h2> <p>Ideal for the security of this application would be to ensure that no information that can be used as an attack surface is ever present outside of the main device package. Such a configuration rules out all but the most concerted attacks, which require intricate knowledge of the target device which is generally not available, sometimes even to defenders.</p> <p>Since the FPGA configuration is loaded via a secure method, the direct attack of which is forbidden by this competition, any configuration data in the FPGA can be considered secure. Careful design of the programmable logic can extend this security to transient data and programs running inside. Thus, if encrypted data enters the FPGA, is processed exclusively there, and then audio outputted, the overall design may be considered secure.</p> <p>The reference design consists of a MicroBlaze soft CPU implemented in the FPGA. This CPU is effectively isolated from the hard CPU, which is considered compromised due to the attacker having root access. The MicroBlaze program is controlled via a shared area of memory inside the FPGA. Some additional fault injection isolation could be achieved by moving this functionality to a more specialized type of memory similar to a peripheral register in a microcontroller, over which the MicroBlaze would have greater authority. This feature, known as the command register, takes over some of the more important functions, and automatically issues an interrupt to the MicroBlaze when written to</p> <p>An integrity monitoring system was proposed to protect the FPGA from side channel attacks. This system would monitor voltages, die temperature, detect a stopped clock or paused MicroBlaze program, and detect clock glitches. The last of these features was not implemented, due to time constrains, and partially due to the assumption that the internal PLL generated clock would be very difficult to attack with clock glitching techniques. In the present implementation, voltage and temperature are monitored by an on chip ADC alarm system, while a stopped MicroBlaze is detected via a watchdog timer.</p> <h2 id="microblaze-performance"><a href="#microblaze-performance" class="header-anchor">#</a> Microblaze Performance</h2> <p>Initially, efforts were made to separate the MicroBlaze into its own clock domain, which could allow it to be better implemented at higher frequencies. This was, on several occasions, enough to boost the MicroBlaze core clock to 140MHz, with the remaining IP still clocked at 100MHz. This also resulted in a significant increase in FPGA resource utilization, required for clock domain crossing logic automatically added to interconnects and miscellaneous signals. The reset scheme for the device was also significantly complicated, requiring about three times as many reset signals, as each signal had to be de-asserted in sync with its clock domain. The device would also have a high chance of failing timing requirements if significant changes were made to any part of the design, leading to numerous wasted builds.</p> <p>It was ultimately determined that the reference design performance of the MicroBlaze soft CPU was sufficient for almost any decryption scheme, and thus capable of playing songs uninterrupted. Given a required throughput of 96KBps (48KHz sample rate at 2 bytes per sample) and an estimated decryption performance of 4 cycles per byte, the processor utilization for decryption alone would be approximately half a percent. The overhead from other code was assumed to be low, given input data was supplied via DMA.</p> <h2 id="song-datapath"><a href="#song-datapath" class="header-anchor">#</a> Song Datapath</h2> <p>Over the course of this project the term Song Datapath was unofficially coined to describe the flow of song data from the storage device to the audio codec. Several changes were made to the data-path to incorporate the MicroBlaze as the means of decryption. It was initially proposed that dedicated crypto IP be obtained for this purpose, but this became unnecessary as the MicroBlaze’s performance was more than sufficient for the chosen cryptography scheme.</p> <p>The final structure of the datapath is as follows. The host program (miPod application) loads the song from the file system into a known physical location in DDR, represented by a device file which is defined in the device tree when the Linux image is built. A DMA transfer is used to fill a FIFO, known as the input FIFO, which is then readable from a dedicated stream port on the MicroBlaze. The MicroBlaze decrypts the samples using a byte-by-byte decryption scheme and outputs them to another stream port, which fills a second FIFO, known as the output FIFO. This second FIFO is then clocked into an I2S codec IP which produces the I2S signal that drives the output device.</p> <p>The changes made to this datapath remove an extra step where the MicroBlaze initiates a memcpy from the initial song location in DDR to a temporary buffer in the FPGA. The purpose of this step is unknown, and it was removed because a call to memcpy would occupy the CPU for no necessary reason. All DMA transfer are issued from the MicroBlaze, no access to this feature is given to the main processor, to prevent potential DMA based attacks.</p> <p>Additional GPIO IP were added to allow the fill level of each FIFO to be monitored from the MicroBlaze. The clocking IP which drove the audio codec clock domain was also modified to be configurable at runtime, allowing audio to be played at an arbitrary sample rate. Stereo output support was also added by splitting the output path into two channels. Playing mono audio in this setup simply requires that each 16-bit mono sample be output “doubled up” to fit the 32-bit width of the output stream.</p> <p>Though the input FIFO is a simple solution, it may have presented challenges in the event the cryptography scheme was changed. Accessing data out of order is especially problematic, since data can only be “popped” out of the FIFO from the end. A more advanced solution might consist of a memory mapped storage scheme, which could keep track of where each run of incoming data was copied from. Such a setup would make it much easier to use the input FIFO as a general purpose interface between the MicroBlaze and main processor.</p> <h2 id="memory"><a href="#memory" class="header-anchor">#</a> Memory</h2> <p>In the chosen scheme, the entire MicroBlaze memory is implemented with internal block RAM, chosen for its resistance to board and OS level attacks as outlined in Xilinx documentation. 128KB is available which must be shared between code, such as text and rodata sections, as well as stack and heap space. When the text size is large compared to the total available memory, stack to heap collisions become extremely likely and fairly irritating to diagnose. Ultimately, the small available memory resources available in the FPGA fabric make it difficult to incorporate sufficient cryptography features.</p> <p>One option to expand available memory is to utilize the on-board DDR, which is accessed through a shared memory interconnect. The MicroBlaze Reference Manual suggests that this has a significant impact on performance depending on data locality (random vs. sequential accesses, presence of cache, etc), which may not have been significant given the predicted low core utilization when a song is actually playing. More significantly is the DDR's susceptibility to attack at an operating system level. Given attackers would have root access to the host operating system, reading arbitrary data from DDR is as simple as reading from /dev/mem. An in-FPGA encryption system between the MicroBlaze and the DDR interconnect could mitigate this attack surface partially, but fault injection attacks would remain a very serious threat, since physical write access to the DDR cannot be denied. Fully incorporating any portion of the DDR into the secure portion of the design would require additional integrity monitoring which would in turn require an extreme amount of FPGA design work. The late stage at which these memory concerns arose made work into this solution impractical compared to attempts to reduce the code size.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/24/2020, 9:43:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mitre/attack.html" class="prev">Attack</a></span> <span class="next"><a href="/technical-reference/authentication.html">Authentication</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a38b3e9.js" defer></script><script src="/assets/js/2.d81d59a6.js" defer></script><script src="/assets/js/14.aa7165da.js" defer></script>
  </body>
</html>
