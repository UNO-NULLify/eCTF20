<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Attack | eCTF Documentation</title>
    <meta name="description" content="NULLify">
    
    
    <link rel="preload" href="/assets/css/0.styles.78f28ec0.css" as="style"><link rel="preload" href="/assets/js/app.1a38b3e9.js" as="script"><link rel="preload" href="/assets/js/2.d81d59a6.js" as="script"><link rel="preload" href="/assets/js/13.fa5546fe.js" as="script"><link rel="prefetch" href="/assets/js/10.007dda0f.js"><link rel="prefetch" href="/assets/js/11.13cf8a39.js"><link rel="prefetch" href="/assets/js/12.914841a3.js"><link rel="prefetch" href="/assets/js/14.aa7165da.js"><link rel="prefetch" href="/assets/js/15.e18563b9.js"><link rel="prefetch" href="/assets/js/16.000a4300.js"><link rel="prefetch" href="/assets/js/17.de36a721.js"><link rel="prefetch" href="/assets/js/18.2dc52e2d.js"><link rel="prefetch" href="/assets/js/19.8a7d5380.js"><link rel="prefetch" href="/assets/js/20.f3895d39.js"><link rel="prefetch" href="/assets/js/21.48e417ca.js"><link rel="prefetch" href="/assets/js/22.949c40a6.js"><link rel="prefetch" href="/assets/js/23.7e7c4a24.js"><link rel="prefetch" href="/assets/js/24.2d48901e.js"><link rel="prefetch" href="/assets/js/25.ceaddddd.js"><link rel="prefetch" href="/assets/js/3.d4afdc96.js"><link rel="prefetch" href="/assets/js/4.90489dad.js"><link rel="prefetch" href="/assets/js/5.037880d8.js"><link rel="prefetch" href="/assets/js/6.071b6179.js"><link rel="prefetch" href="/assets/js/7.f0459ecd.js"><link rel="prefetch" href="/assets/js/8.f6099ec2.js"><link rel="prefetch" href="/assets/js/9.48e6ce21.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78f28ec0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/nullify_lock_no_padding.png" alt="eCTF Documentation" class="logo"> <span class="site-name can-hide">eCTF Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link router-link-active">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link">Technical Reference</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/mitre/" class="nav-link router-link-active">Official Documentation</a></div><div class="nav-item"><a href="/technical-reference/" class="nav-link">Technical Reference</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/mitre/" class="sidebar-heading clickable router-link-active open"><span>Official Documentation</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mitre/overview.html" class="sidebar-link">System Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/overview.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#usage" class="sidebar-link">Usage</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#mipod-command-information" class="sidebar-link">miPod Command Information</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#media-command-information" class="sidebar-link">Media Command Information</a></li><li class="sidebar-sub-header"><a href="/mitre/overview.html#operating-times" class="sidebar-link">Operating Times</a></li></ul></li><li><a href="/mitre/implementation.html" class="sidebar-link">Security Implementation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/implementation.html#protection-of-flags" class="sidebar-link">Protection of Flags</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/implementation.html#region-lock" class="sidebar-link">Region Lock</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#unauthorized-play" class="sidebar-link">Unauthorized Play</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#pin-extraction" class="sidebar-link">Pin Extraction</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#music-tamper" class="sidebar-link">Music Tamper</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#custom-music" class="sidebar-link">Custom Music</a></li></ul></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#compiler-changes" class="sidebar-link">Compiler Changes</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#hardware-changes" class="sidebar-link">Hardware Changes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/implementation.html#hardware-integrity-module" class="sidebar-link">Hardware Integrity Module</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#command-register" class="sidebar-link">Command Register</a></li></ul></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#data-flow" class="sidebar-link">Data Flow</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#watchdog" class="sidebar-link">Watchdog</a></li><li class="sidebar-sub-header"><a href="/mitre/implementation.html#integrity-monitor" class="sidebar-link">Integrity Monitor</a></li></ul></li><li><a href="/mitre/attack.html" class="active sidebar-link">Attack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/attack.html#potential-vulnerabilities" class="sidebar-link">Potential Vulnerabilities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/attack.html#mipod" class="sidebar-link">miPod</a></li><li class="sidebar-sub-header"><a href="/mitre/attack.html#drm" class="sidebar-link">DRM</a></li><li class="sidebar-sub-header"><a href="/mitre/attack.html#security-and-function-overview" class="sidebar-link">Security and function Overview</a></li><li class="sidebar-sub-header"><a href="/mitre/attack.html#hardware" class="sidebar-link">Hardware</a></li></ul></li></ul></li><li><a href="/mitre/hardware.html" class="sidebar-link">Hardware Considerations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mitre/hardware.html#security-challenges" class="sidebar-link">Security Challenges</a></li><li class="sidebar-sub-header"><a href="/mitre/hardware.html#microblaze-performance" class="sidebar-link">Microblaze Performance</a></li><li class="sidebar-sub-header"><a href="/mitre/hardware.html#song-datapath" class="sidebar-link">Song Datapath</a></li><li class="sidebar-sub-header"><a href="/mitre/hardware.html#memory" class="sidebar-link">Memory</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/technical-reference/" class="sidebar-heading clickable"><span>Technical Reference</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="attack"><a href="#attack" class="header-anchor">#</a> Attack</h1> <h2 id="potential-vulnerabilities"><a href="#potential-vulnerabilities" class="header-anchor">#</a> Potential Vulnerabilities</h2> <p>The following is a curated list of potential vulnerabilities identified in the reference design via code review. These potential vulnerabilities combine to form what was our starting point for the attack phase.</p> <h3 id="mipod"><a href="#mipod" class="header-anchor">#</a> miPod</h3> <h5 id="mipod-src-main-c"><a href="#mipod-src-main-c" class="header-anchor">#</a> /miPod/src/main.c</h5> <div class="language- extra-class"><pre class="language-text"><code>    (lines 31 and 32)

    system(&quot;devmem 0x41200000 32 0&quot;);

    system(&quot;devmem 0x41200000 32 1&quot;);
</code></pre></div><p>Uses system to call devmem -- this binary is located at /sbin/devmem and can be replaced with a malicious binary.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 109 and 110)

    strcpy((void*)c-&gt;username, username);

    strcpy((void*)c-&gt;pin, pin);
</code></pre></div><p>Uses strcopy -- does not perform bounds checking.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 200)

    strcpy((char *)c-&gt;username, username);
</code></pre></div><p>Uses strcopy -- does not perform bounds checking.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 78)

    fd = open(fname, O_RDONLY);
</code></pre></div><p>We may be able to manipulate the environment to change what is opened or use a race condition</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 215)

    fd = open(song_name, O_WRONLY);
</code></pre></div><p>We may be able to manipulate the environment to change what is opened or use a race condition</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 322)

    int fd = open(fname, O_WRONLY | O_CREAT | O_TRUNC);
</code></pre></div><p>We may be able to manipulate the environment to change what is opened or use a race condition</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 353)

    mem = open(&quot;/dev/uio0&quot;, O_RDWR);

    c = mmap(NULL, sizeof(cmd_channel), PROT_READ | PROT_WRITE, MAP_SHARED, mem, 0);
</code></pre></div><p>We can watch/modify the contents of this.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 89)

    read(fd, song_buf, sb.st_size);
</code></pre></div><p>Check the size of the buffer vs what is passed.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 272, 275, 278)

    usleep(200000); // wait for DRM to print

    . . .

    usleep(200000); // wait for DRM to print

    . . .

    usleep(200000); // wait for DRM to print
</code></pre></div><p>uses depricated usleep instead of nanosleep() or setitimer().</p> <hr> <h5 id="mipod-src-mipod-h"><a href="#mipod-src-mipod-h" class="header-anchor">#</a> /miPod/src/mipod.h</h5> <div class="language- extra-class"><pre class="language-text"><code>    (lines 25, 28, and 29)

    usleep(200000); // wait for DRM to print

    . . .

    #define print_prompt() printf(USER_PROMPT, &quot;&quot;)

    #define print_prompt_msg(...) printf(USER_PROMPT, __VA_ARGS__)
</code></pre></div><p>Format string attack may be possible on uses of mp_printf(), print_prompt(), and print_prompt_msg() -- not format specified.</p> <hr> <h3 id="drm"><a href="#drm" class="header-anchor">#</a> DRM</h3> <h5 id="mb-drm-audio-fw-src-constants-h"><a href="#mb-drm-audio-fw-src-constants-h" class="header-anchor">#</a> /mb/drm_audio_fw/src/constants.h</h5> <div class="language- extra-class"><pre class="language-text"><code>    // shared DDR address
    #define SHARED_DDR_BASE (0x20000000 + 0x1CC00000)

    // memory constants
    #define CHUNK_SZ 16000
    #define FIFO_CAP 4096*4

    // number of seconds to record/playback
    #define PREVIEW_TIME_SEC 30

    // ADC/DAC sampling rate in Hz
    #define AUDIO_SAMPLING_RATE 48000
    #define BYTES_PER_SAMP 2
    #define PREVIEW_SZ (PREVIEW_TIME_SEC * AUDIO_SAMPLING_RATE * BYTES_PER_SAMP)

    // printing utility
    #define MB_PROMPT &quot;\r\nMB&gt; &quot;
    #define mb_printf(...) xil_printf(MB_PROMPT __VA_ARGS__)

    // protocol constants
    #define MAX_REGIONS 64
    #define REGION_NAME_SZ 64
    #define MAX_USERS 64
    #define USERNAME_SZ 64
    #define MAX_PIN_SZ 64
    #define MAX_SONG_SZ (1&lt;&lt;25)
</code></pre></div><p>Many of the macros used throughout main.c are noted above, including the address of the mmap for IPC, sampling rates, and various values related to owners, songs, and pins.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 31)

    #define MAX_SONG_SZ (1&lt;&lt;25)
</code></pre></div><p>Why would they not just use the number? Also, according to Frank, this number is incorrect by default.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 23)

    #define mb_printf(...) xil_printf(MB_PROMPT __VA_ARGS__)
</code></pre></div><p>All uses of mb_printf (which is used for the system prompt and all print statements) need a formatter in the string that is passed to it. Otherwise, they may be vulnerable to a string format attack.</p> <hr> <h5 id="mb-drm-audio-fw-src-main-c"><a href="#mb-drm-audio-fw-src-main-c" class="header-anchor">#</a> /mb/drm_audio_fw/src/main.c</h5> <div class="language- extra-class"><pre class="language-text"><code>    (lines 34 - 38)

    // change states
    #define change_state(state, color) c-&gt;drm_state = state; setLED(led, color);
    #define set_stopped() change_state(STOPPED, RED)
    #define set_working() change_state(WORKING, YELLOW)
    #define set_playing() change_state(PLAYING, GREEN)
    #define set_paused()  change_state(PAUSED, BLUE)
</code></pre></div><p>Important note regarding the lights on the Xilinx board and what actions they correspond to.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 51 - 56)

    // shared variable between main thread and interrupt processing thread
    volatile static int InterruptProcessed = FALSE;
    static XIntc InterruptController;

    void myISR(void) {
    InterruptProcessed = TRUE;
    } 
</code></pre></div><p>The function myISR registers the interrupt as being processed.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 164)
    mb_printf(&quot;No user logged in&quot;);
</code></pre></div><p>This printf does not contain a format specifier and the stack may be able to be leaked if attacked using a string format attack.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 195 - 199)

    if (!locked) {
        mb_printf(&quot;Region Match. Full Song can be played. Unlocking...&quot;);
    } else {
        mb_printf(&quot;Invalid region&quot;);
    }
</code></pre></div><p>More missing format specifiers (there are 2 here).</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 227)

    mb_printf(&quot;Already logged in. Please log out first.\r\n&quot;);
</code></pre></div><p>More missing format specifiers.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 246 and 255)

    mb_printf(&quot;Incorrect pin for user '%s'\r\n&quot;, c-&gt;username);

    mb_printf(&quot;User not found\r\n&quot;);
</code></pre></div><p>The user should not know if the username or pin were incorrect, upon unsuccessful login. This should be removed in our design.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 265 and 272)

    mb_printf(&quot;Logging out...\r\n&quot;);

    . . .

    mb_printf(&quot;Not logged in\r\n&quot;);
</code></pre></div><p>More missing format specifiers.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 369)

    mb_printf(&quot;Reading Audio File...&quot;);
</code></pre></div><p>More missing format specifiers.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 382)

    mb_printf(&quot;Song is unlocked. Playing full song\r\n&quot;);
</code></pre></div><p>More missing formatters.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 393 - 415)

    while (InterruptProcessed) {
            InterruptProcessed = FALSE;

            switch (c-&gt;cmd) {
            case PAUSE:
                mb_printf(&quot;Pausing... \r\n&quot;);
                set_paused();
                while (!InterruptProcessed) continue; // wait for interrupt
                break;
            case PLAY:
                mb_printf(&quot;Resuming... \r\n&quot;);
                set_playing();
                break;
            case STOP:
                mb_printf(&quot;Stopping playback...&quot;);
                return;
            case RESTART:
                mb_printf(&quot;Restarting song... \r\n&quot;);
                rem = length; // reset song counter
                set_playing();
            default:
                break;
            }
    }
</code></pre></div><p>These are all missing format specifiers.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 453 and 454)

    c-&gt;song.file_size -= c-&gt;song.md.md_size;
    c-&gt;song.wav_size -= c-&gt;song.md.md_size;
</code></pre></div><p>All operations that rely on trusted data need to be performed on the local struct, not the shared one.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (lines 492 - 497)

    // Congigure the DMA
    status = fnConfigDma(&amp;sAxiDma);
    if(status != XST_SUCCESS) {
    mb_printf(&quot;DMA configuration ERROR\r\n&quot;);
    return XST_FAILURE;
    }
</code></pre></div><p>This printf does not contain a format specifier and the stack may be able to be leaked if attacked using a string format attack.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 506)

    mb_printf(&quot;Audio DRM Module has Booted\n\r&quot;);
</code></pre></div><p>This printf does not contain a format specifier and the stack may be able to be leaked if attacked using a string format attack.</p> <hr> <div class="language- extra-class"><pre class="language-text"><code>    (line 532 - 534)

    case PLAY:
    play_song();
    mb_printf(&quot;Done Playing Song\r\n&quot;);
</code></pre></div><p>This printf does not contain a format specifier and the stack may be able to be leaked if attacked using a string format attack.</p> <p>IMPORTANT NOTE: There are MANY uses of strcmp in the reference code, we should replace these with strncmp and specify an expected size.</p> <hr> <h5 id="mb-drm-audio-fw-src-secrets-h"><a href="#mb-drm-audio-fw-src-secrets-h" class="header-anchor">#</a> /mb/drm_audio_fw/src/secrets.h</h5> <p>This headerfile is overwritten by the Python buildDevice script.</p> <hr> <h5 id="mb-drm-audio-fw-src-util-c"><a href="#mb-drm-audio-fw-src-util-c" class="header-anchor">#</a> /mb/drm_audio_fw/src/util.c</h5> <p>This file contains the basic setup for changing the LEDs, setting up the interrupt system, and configuring the I2S controller.</p> <div class="language- extra-class"><pre class="language-text"><code>    (lines 141 - 146)

    if(XAxiDma_HasSg(AxiDma))
    {
        xil_printf(MB_PROMPT &quot;Device configured as SG mode\r\n&quot;);

        return XST_FAILURE;
    }
</code></pre></div><p>The code handling an issue where the I2S module is in SG mode has a print statement with no format specifier.</p> <hr> <h3 id="security-and-function-overview"><a href="#security-and-function-overview" class="header-anchor">#</a> Security and function Overview</h3> <p>Below is a summary of all the functions added in the new design.</p> <h4 id="cachecmd"><a href="#cachecmd" class="header-anchor">#</a> cacheCMD</h4> <p>In this function, we copy the necessary parts of the IPC channel, so that we have a local copy of the data in BRAM that we can trust.</p> <h4 id="loadsongmd"><a href="#loadsongmd" class="header-anchor">#</a> loadSongMD</h4> <p>This function will load the metadata of a song into the SongMD struct. It is currently in an unfinished state.</p> <h4 id="decryptsong"><a href="#decryptsong" class="header-anchor">#</a> decryptSong</h4> <p>This function will decrypt the song. This is kind of Drew's thing and it hasn't been written yet, so I don't know the details...</p> <h4 id="checkauth"><a href="#checkauth" class="header-anchor">#</a> checkAuth</h4> <p>This function checks if the user and player are authorized to play a given song. It specifically checks if the user is an owner of the song, if they have had the song shared with them, and then if the device is provisioned for one of the regions that the song is provisioned for.</p> <h4 id="logon"><a href="#logon" class="header-anchor">#</a> logOn</h4> <p>Allows the user to login by checking if they are already logged in, checking if the username is provisioned for the board, and then checking the hash of the given pin against the stored hash of the user's pin. If they are already logged in, it will print a message saying so, otherwise there will be no or a generic error.</p> <h4 id="logoff"><a href="#logoff" class="header-anchor">#</a> logOff</h4> <p>Checks if the users is logged in and if they are, then it wipes the UserMD struct.</p> <h4 id="share"><a href="#share" class="header-anchor">#</a> share</h4> <p>Checks if the user is logged in, if they are the owner of the song, if the recipient exists, if the recipient already has access to the song, and if the song can be shared. If all of those checks pass, then it performs all functionality needed to share the song with the user.</p> <h4 id="querysong"><a href="#querysong" class="header-anchor">#</a> querySong</h4> <p>Checks if the user is logged in and if the song is loaded. If those pass, then it prints out all of the song regions, the song owner, and all shared users.</p> <h4 id="queryplayer"><a href="#queryplayer" class="header-anchor">#</a> queryPlayer</h4> <p>Prints all of the player regions and all of the device users.</p> <h4 id="main"><a href="#main" class="header-anchor">#</a> main</h4> <p>Wipes the command channel, the songMD struct, UserMD struct, processes the interrupt, calls cacheCMD to cache the command channel, and calls the correct function based off of the command given.</p> <h3 id="hardware"><a href="#hardware" class="header-anchor">#</a> Hardware</h3> <h5 id="cold-boot-attacks"><a href="#cold-boot-attacks" class="header-anchor">#</a> Cold Boot Attacks</h5> <p><strong>Step 1:</strong> freeze the processor with compressed air!</p> <p><strong>Step 2:</strong> Power down board while continuing to use compressed air on the CPU</p> <p><strong>Step 3:</strong> while continuing to apply compressed air boot the board with a modified pl that allows for dram to be dumped</p> <p><strong>Step 4:</strong> Listen to the socket for the dram dumped out by the custom pl</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/24/2020, 9:26:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mitre/implementation.html" class="prev">Security Implementation</a></span> <span class="next"><a href="/mitre/hardware.html">Hardware Considerations</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1a38b3e9.js" defer></script><script src="/assets/js/2.d81d59a6.js" defer></script><script src="/assets/js/13.fa5546fe.js" defer></script>
  </body>
</html>
